{% extends 'admin/base.html' %}

{% block title %}Comments Management{% endblock %}

{% block content %}
<div class="page-header d-flex justify-content-between align-items-center">
    <div>
        <h1>Comments Management</h1>
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{{ url_for('admin.dashboard') }}">Dashboard</a></li>
                <li class="breadcrumb-item"><a href="{{ url_for('admin.blog_posts') }}">Blog Posts</a></li>
                <li class="breadcrumb-item active" aria-current="page">Comments</li>
            </ol>
        </nav>
    </div>
</div>

<!-- Flash Messages -->
{% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        {% for category, message in messages %}
            <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        {% endfor %}
    {% endif %}
{% endwith %}

<!-- Comment Statistics -->
<div class="row mb-4">
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card stat-card primary h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <div class="stat-card-title">Total Comments</div>
                        <div class="stat-card-value">{{ comments|length }}</div>
                    </div>
                    <div class="stat-card-icon">
                        <i class="fas fa-comments"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card stat-card success h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <div class="stat-card-title">Approved</div>
                        <div class="stat-card-value">{{ approved_comments|length }}</div>
                    </div>
                    <div class="stat-card-icon">
                        <i class="fas fa-check-circle"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card stat-card warning h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <div class="stat-card-title">Pending</div>
                        <div class="stat-card-value">{{ pending_comments|length }}</div>
                    </div>
                    <div class="stat-card-icon">
                        <i class="fas fa-clock"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card stat-card info h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <div class="stat-card-title">Spam</div>
                        <div class="stat-card-value">{{ spam_comments|length }}</div>
                    </div>
                    <div class="stat-card-icon">
                        <i class="fas fa-ban"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Comments Table -->
<div class="card mb-4">
    <div class="card-header">
        <h6 class="mb-0">All Comments</h6>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover datatable" id="commentsTable">
                <thead>
                    <tr>
                        <th>Author</th>
                        <th>Comment</th>
                        <th>Post</th>
                        <th>Date</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% if comments %}
                        {% for comment in comments %}
                            <tr>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="bg-light rounded-circle d-flex align-items-center justify-content-center me-2" style="width: 40px; height: 40px;">
                                            <i class="fas fa-user text-muted"></i>
                                        </div>
                                        <div>
                                            <div>{{ comment.name }}</div>
                                            <small class="text-muted">{{ comment.email }}</small>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <div class="text-truncate" style="max-width: 250px;">
                                        {{ comment.content }}
                                    </div>
                                    <button class="btn btn-sm btn-link p-0" data-bs-toggle="modal" data-bs-target="#viewCommentModal{{ comment.id }}">
                                        View full comment
                                    </button>
                                </td>
                                <td>
                                    <a href="{{ url_for('blog.post', slug=comment.post.slug) }}" target="_blank">
                                        {{ comment.post.title }}
                                    </a>
                                </td>
                                <td>
                                    <div class="d-flex flex-column">
                                        <span>{{ comment.created_at.strftime('%b %d, %Y') }}</span>
                                        <small class="text-muted">{{ comment.created_at.strftime('%H:%M') }}</small>
                                    </div>
                                </td>
                                <td>
                                    {% if comment.status == 'approved' %}
                                        <span class="badge bg-success">Approved</span>
                                    {% elif comment.status == 'pending' %}
                                        <span class="badge bg-warning text-dark">Pending</span>
                                    {% elif comment.status == 'spam' %}
                                        <span class="badge bg-danger">Spam</span>
                                    {% endif %}
                                </td>
                                <td class="table-actions">
                                    {% if comment.status != 'approved' %}
                                        <a href="{{ url_for('admin.approve_comment', id=comment.id) }}" class="btn btn-sm btn-success" title="Approve">
                                            <i class="fas fa-check"></i>
                                        </a>
                                    {% endif %}
                                    
                                    {% if comment.status != 'spam' %}
                                        <a href="{{ url_for('admin.mark_spam', id=comment.id) }}" class="btn btn-sm btn-warning" title="Mark as Spam">
                                            <i class="fas fa-ban"></i>
                                        </a>
                                    {% endif %}
                                    
                                    <button class="btn btn-sm btn-info" data-bs-toggle="modal" data-bs-target="#replyCommentModal{{ comment.id }}" title="Reply">
                                        <i class="fas fa-reply"></i>
                                    </button>
                                    
                                    <button class="btn btn-sm btn-danger" data-bs-toggle="modal" data-bs-target="#deleteCommentModal{{ comment.id }}" title="Delete">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                            
                            <!-- View Comment Modal -->
                            <div class="modal fade" id="viewCommentModal{{ comment.id }}" tabindex="-1" aria-labelledby="viewCommentModalLabel{{ comment.id }}" aria-hidden="true">
                                <div class="modal-dialog">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <h5 class="modal-title" id="viewCommentModalLabel{{ comment.id }}">Comment from {{ comment.name }}</h5>
                                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                        </div>
                                        <div class="modal-body">
                                            <div class="mb-3">
                                                <strong>Author:</strong> {{ comment.name }}
                                            </div>
                                            <div class="mb-3">
                                                <strong>Email:</strong> {{ comment.email }}
                                            </div>
                                            {% if comment.website %}
                                                <div class="mb-3">
                                                    <strong>Website:</strong> <a href="{{ comment.website }}" target="_blank">{{ comment.website }}</a>
                                                </div>
                                            {% endif %}
                                            <div class="mb-3">
                                                <strong>Date:</strong> {{ comment.created_at.strftime('%b %d, %Y at %H:%M') }}
                                            </div>
                                            <div class="mb-3">
                                                <strong>Post:</strong> <a href="{{ url_for('blog.post', slug=comment.post.slug) }}" target="_blank">{{ comment.post.title }}</a>
                                            </div>
                                            <div class="mb-3">
                                                <strong>Status:</strong>
                                                {% if comment.status == 'approved' %}
                                                    <span class="badge bg-success">Approved</span>
                                                {% elif comment.status == 'pending' %}
                                                    <span class="badge bg-warning text-dark">Pending</span>
                                                {% elif comment.status == 'spam' %}
                                                    <span class="badge bg-danger">Spam</span>
                                                {% endif %}
                                            </div>
                                            <div class="mb-3">
                                                <strong>IP Address:</strong> {{ comment.ip_address }}
                                            </div>
                                            <div class="mb-3">
                                                <strong>Comment:</strong>
                                                <div class="p-3 bg-light rounded mt-2">
                                                    {{ comment.content }}
                                                </div>
                                            </div>
                                        </div>
                                        <div class="modal-footer">
                                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Reply Comment Modal -->
                            <div class="modal fade" id="replyCommentModal{{ comment.id }}" tabindex="-1" aria-labelledby="replyCommentModalLabel{{ comment.id }}" aria-hidden="true">
                                <div class="modal-dialog">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <h5 class="modal-title" id="replyCommentModalLabel{{ comment.id }}">Reply to {{ comment.name }}</h5>
                                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                        </div>
                                        <form action="{{ url_for('admin.reply_comment', id=comment.id) }}" method="POST">
                                            <div class="modal-body">
                                                <div class="mb-3">
                                                    <label class="form-label">Original Comment:</label>
                                                    <div class="p-3 bg-light rounded">
                                                        {{ comment.content }}
                                                    </div>
                                                </div>
                                                <div class="mb-3">
                                                    <label for="replyContent{{ comment.id }}" class="form-label">Your Reply:</label>
                                                    <textarea class="form-control" id="replyContent{{ comment.id }}" name="content" rows="4" required></textarea>
                                                </div>
                                                <div class="form-check mb-3">
                                                    <input class="form-check-input" type="checkbox" id="notifyAuthor{{ comment.id }}" name="notify_author" checked>
                                                    <label class="form-check-label" for="notifyAuthor{{ comment.id }}">
                                                        Notify author by email
                                                    </label>
                                                </div>
                                            </div>
                                            <div class="modal-footer">
                                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                                <button type="submit" class="btn btn-primary">Send Reply</button>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Delete Comment Modal -->
                            <div class="modal fade" id="deleteCommentModal{{ comment.id }}" tabindex="-1" aria-labelledby="deleteCommentModalLabel{{ comment.id }}" aria-hidden="true">
                                <div class="modal-dialog">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <h5 class="modal-title" id="deleteCommentModalLabel{{ comment.id }}">Delete Comment</h5>
                                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                        </div>
                                        <div class="modal-body">
                                            <p>Are you sure you want to delete this comment from <strong>{{ comment.name }}</strong>?</p>
                                            <div class="p-3 bg-light rounded">
                                                <div class="text-truncate">{{ comment.content }}</div>
                                            </div>
                                            <p class="text-danger mt-3"><i class="fas fa-exclamation-triangle"></i> This action cannot be undone.</p>
                                        </div>
                                        <div class="modal-footer">
                                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                            <a href="{{ url_for('admin.delete_comment', id=comment.id) }}" class="btn btn-danger">Delete</a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    {% else %}
                        <tr>
                            <td colspan="6" class="text-center py-4">
                                <i class="fas fa-comments text-muted mb-2" style="font-size: 2rem;"></i>
                                <p class="mb-0">No comments found</p>
                            </td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Comment Settings -->
<div class="card">
    <div class="card-header">
        <h6 class="mb-0">Comment Settings</h6>
    </div>
    <div class="card-body">
        <form action="{{ url_for('admin.update_comment_settings') }}" method="POST">
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3 form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="enableComments" name="enable_comments" {% if settings.enable_comments %}checked{% endif %}>
                        <label class="form-check-label" for="enableComments">Enable comments globally</label>
                    </div>
                    
                    <div class="mb-3 form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="moderateComments" name="moderate_comments" {% if settings.moderate_comments %}checked{% endif %}>
                        <label class="form-check-label" for="moderateComments">Moderate comments before publishing</label>
                    </div>
                    
                    <div class="mb-3 form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="emailNotifications" name="email_notifications" {% if settings.email_notifications %}checked{% endif %}>
                        <label class="form-check-label" for="emailNotifications">Email notifications for new comments</label>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="maxCommentLength" class="form-label">Maximum comment length</label>
                        <input type="number" class="form-control" id="maxCommentLength" name="max_comment_length" value="{{ settings.max_comment_length }}" min="100" max="10000">
                        <div class="form-text">Maximum number of characters allowed in a comment</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="commentsPerPage" class="form-label">Comments per page</label>
                        <input type="number" class="form-control" id="commentsPerPage" name="comments_per_page" value="{{ settings.comments_per_page }}" min="5" max="100">
                        <div class="form-text">Number of comments to display per page on blog posts</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="commentOrder" class="form-label">Comment display order</label>
                        <select class="form-select" id="commentOrder" name="comment_order">
                            <option value="newest" {% if settings.comment_order == 'newest' %}selected{% endif %}>Newest first</option>
                            <option value="oldest" {% if settings.comment_order == 'oldest' %}selected{% endif %}>Oldest first</option>
                        </select>
                    </div>
                </div>
                
                <div class="col-12 mt-3">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Save Settings
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    $(document).ready(function() {
        // Initialize DataTable with status filter
        var table = $('#commentsTable').DataTable({
            order: [[3, 'desc']], // Sort by date descending by default
            columnDefs: [
                { orderable: false, targets: [5] } // Disable sorting for actions column
            ]
        });
        
        // Add status filter
        $('#commentsTable_filter').prepend(
            '<div class="me-3 d-inline-block">'
            + '<select id="statusFilter" class="form-select form-select-sm">'
            + '<option value="">All Statuses</option>'
            + '<option value="Approved">Approved</option>'
            + '<option value="Pending">Pending</option>'
            + '<option value="Spam">Spam</option>'
            + '</select>'
            + '</div>'
        );
        
        // Add post filter
        $('#commentsTable_filter').prepend(
            '<div class="me-3 d-inline-block">'
            + '<select id="postFilter" class="form-select form-select-sm">'
            + '<option value="">All Posts</option>'
            {% for post in posts %}
            + '<option value="{{ post.title }}">{{ post.title }}</option>'
            {% endfor %}
            + '</select>'
            + '</div>'
        );
        
        // Apply status filter
        $('#statusFilter').on('change', function() {
            var status = $(this).val();
            table.column(4).search(status).draw();
        });
        
        // Apply post filter
        $('#postFilter').on('change', function() {
            var post = $(this).val();
            table.column(2).search(post).draw();
        });
    });
</script>
{% endblock %}