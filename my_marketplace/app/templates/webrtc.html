<!DOCTYPE html>
<html>
<head>
    <title>WebRTC Demo</title>
</head>
<body>
    <h1>WebRTC Demo</h1>
    <video id="localVideo" autoplay muted></video>
    <video id="remoteVideo" autoplay></video>
    <br>
    <button id="startButton">Start</button>
    <button id="callButton">Call</button>
    <button id="hangupButton">Hang Up</button>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script>
        const startButton = document.getElementById('startButton');
        const callButton = document.getElementById('callButton');
        const hangupButton = document.getElementById('hangupButton');
        const localVideo = document.getElementById('localVideo');
        const remoteVideo = document.getElementById('remoteVideo');

        let localStream;
        let pc;
        let room = 'test_room'; // Example room name

        const socket = io('/webrtc');

        startButton.onclick = async () => {
            localStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: true });
            localVideo.srcObject = localStream;
            socket.emit('join', { room: room });
        };

        callButton.onclick = async () => {
            pc = new RTCPeerConnection();
            pc.onicecandidate = event => {
                if (event.candidate) {
                    socket.emit('candidate', { room: room, candidate: event.candidate });
                }
            };
            pc.ontrack = event => {
                remoteVideo.srcObject = event.streams[0];
            };
            localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

            const offer = await pc.createOffer();
            await pc.setLocalDescription(offer);
            socket.emit('offer', { room: room, offer: offer });
        };

        hangupButton.onclick = () => {
            pc.close();
            socket.emit('leave', { room: room });
        };

        socket.on('user_joined', async (data) => {
            console.log('user joined', data);
        });

        socket.on('offer', async (data) => {
            pc = new RTCPeerConnection();
            pc.onicecandidate = event => {
                if (event.candidate) {
                    socket.emit('candidate', { room: room, candidate: event.candidate });
                }
            };
            pc.ontrack = event => {
                remoteVideo.srcObject = event.streams[0];
            };
            localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

            await pc.setRemoteDescription(data.offer);
            const answer = await pc.createAnswer();
            await pc.setLocalDescription(answer);
            socket.emit('answer', { room: room, answer: answer });
        });

        socket.on('answer', async (data) => {
            await pc.setRemoteDescription(data.answer);
        });

        socket.on('candidate', async (data) => {
            await pc.addIceCandidate(data.candidate);
        });

        socket.on('user_left', (data) => {
            remoteVideo.srcObject = null;
        });

    </script>
</body>
</html>